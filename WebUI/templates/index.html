<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <title>IMG OCR</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.css" integrity="sha512-nNlU0WK2QfKsuEmdcTwkeh+lhGs6uyOxuUs+n+0oXSYDok5qy0EI0lt01ZynHq6+p/tbgpZ7P+yUb+r71wqdXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js" integrity="sha512-j7/1CJweOskkQiS5RD9W8zhEG9D9vpgByNGxPIqkO5KrXrwyDAroM9aQ9w8J7oRqwxGyz429hPVk/zR6IOMtSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" integrity="sha512-2eMmukTZtvwlfQoG8ztapwAH5fXaQBzaMqdljLopRSA0i6YKM8kBAOrSSykxu9NN9HrtD45lIqfONLII2AFL/Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.js" integrity="sha512-vUJTqeDCu0MKkOhuI83/MEX5HSNPW+Lw46BA775bAWIp1Zwgz3qggia/t2EnSGB9GoS2Ln6npDmbJTdNhHy1Yw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
	.pic-cropper{
		border:1px solid #099;
		width: 600px;
		height: 1040px;
		margin:auto;
		display: flex;
		flex-direction: column;
		align-items: center;
		padding-top: 20px;
	}

	#submit {
		margin-top: 10px;
		margin-bottom: 10px;
	}

	#export {
		margin-top: 10px;
		margin-bottom: 10px;
	}

	#result-canvas {
		border:1px solid #CCCCCC
	}

	#image-canvas {
		border:1px solid #CCCCCC
	}
	</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-secondary">
        <div class="container-fluid">
            <a class="navbar-brand mt-2 mt-lg-0" href="{{url_for('index')}}">
                <h5 class="pt-1">Image Optical Character Recognition Web Interface</h5>
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1 class="text-center pt-5">IMG OCR TOOL</h1>
        </div>

        <hr/>

        <div class="pt-3"></div>

        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="chinese_vertical">
            <label class="form-check-label" for="chinese_vertical">Chinese Vertical Right To Left Format</label>
        </div>

        <!-- tester -->

        <div style="text-align:center;padding:10px"><input id="img-input" type="file"/></div>
        <div class="pic-cropper">
            <input id="slider" type="range"/>
            <canvas id="image-canvas" width="500" height="500"></canvas>
            <button id="submit">Preview</button>
            <canvas id="result-canvas" width="400" height="400"></canvas>
            <button id="export">Commit</button>
        </div>

        <!-- tester -->

        <div>
            <form class="form-inline pt-3 text-center" action="uploadimg" method="post" enctype="multipart/form-data">
                <input class="form-control" type="file" multiple="" name="file1[]">
                <br/>
                <input class="form-control btn btn-primary" type="submit" value="IMG Upload">
            </form>
        </div>

        <div class="pt-3"></div>

        <div>
            <form class="form-inline pt-3 text-center" action="uploadpdf" method="post" enctype="multipart/form-data">
                <input class="form-control" type="file" name="file2[]">
                <br/>
                <input class="form-control btn btn-primary" type="submit" value="PDF Upload">
            </form>
        </div>

        <div class="pt-5"></div>

        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 id="flask_progress" role="progressbar" aria-valuenow="0"
                 aria-valuemin="0" aria-valuemax="100" style="width:0%">
                0%
            </div>
        </div>
    </div>

    <script>
        var imgInput = document.getElementById("img-input");
        var submitBtn = document.getElementById("submit");
        var exportBtn = document.getElementById("export");
        var mySlider = document.getElementById("slider");
        var resultCanvas = document.getElementById("result-canvas");
        var resultCxt = resultCanvas.getContext("2d");
        var imgCanvas = document.getElementById("image-canvas");
        var imgCxt = imgCanvas.getContext("2d");
        var currentFactor = 1; // current scaling ratio
        var minFactor = 1; // minimum scaling ratio
        var maxFactor = 1; // maximum scaling ratio
        var ori = document.getElementById("image-canvas").height;
        var cut = document.getElementById("result-canvas").height;
        console.log(ori);
        console.log(cut);
        var img = new Image();
        img.setAttribute('crossOrigin', 'anonymous');

        // const imgUrl = "https://udi-official-website.oss-cn-shenzhen.aliyuncs.com/0/rc-upload-1584349106386-2";

        imgInput.onchange = function() {
            console.log("======",imgInput.files[0]);
           var imgUrl =  URL.createObjectURL(imgInput.files[0]);
           imgCanvas.setAttribute('height', ori);
           resultCanvas.setAttribute('height',cut);
           drawMask();
           getImage(imgUrl);
            // var fileReader = new FileReader();
            // fileReader.readAsBinaryString(imgInput.files[0]);
        }

        // obtain image and draw
        getImage = function(imgUrl) {
            // img.src = './changtuxiang.jpg'
            img.src=imgUrl;
            img.onload = function() {
                calculateFactor();
                var originPosition = canvasOriginPosition();
                imgCxt.globalCompositeOperation = "destination-over";
                imgCxt.drawImage(img,originPosition.positionX,originPosition.positionY,img.width*currentFactor,img.height*currentFactor);
            }
        }

        // draw mask
        drawMask = function() {
            imgCxt.fillStyle = "rgba(0,0,0,0.5)";
            imgCxt.fillRect(0,0,ori,ori);
            imgCxt.fillStyle = "rgba(0,0,0,1)";
            imgCxt.globalCompositeOperation = "destination-out";
            imgCxt.fillRect(50,50,cut,cut);
        }

        // canvas last mouse action
        var moving = false;
        var lastmouseX = null;
        var lastmouseY = null;

        // canvas last movement result
        var lastImgX = 0;
        var lastImgY = 0;

        imgCanvas.onmousedown=function(e) {
            // console.log("onmousedown",lastImgX,lastImgY);
            moving = true;
            lastmouseX = e.clientX;
            lastmouseY = e.clientY;
        }

        window.onmouseup = function(e) {
            if(moving === true) {
                moving = false;
                var newPosition = checkPosition(e.clientX - lastmouseX,e.clientY - lastmouseY)
                // change image position
                lastImgX = newPosition.X;
                lastImgY = newPosition.Y;
                // console.log("onmouseup",lastImgX,lastImgY);
            }
        }

        redrawImg = function(pX,pY) {
            // check position whether in range or not before redraw
            var newPosition = checkPosition(pX,pY)
            imgCanvas.setAttribute('height', ori);
            drawMask();
            imgCxt.globalCompositeOperation = "destination-over";
            imgCxt.drawImage(img,newPosition.X,newPosition.Y,img.width*currentFactor,img.height*currentFactor);

        }

        checkPosition = function(pX,pY) {
            if(pX+lastImgX<=50&&pX+lastImgX>=cut+50-img.width*currentFactor&&pY+lastImgY<=50&&pY+lastImgY>=cut+50-img.height*currentFactor) {
                return ({"X":pX+lastImgX,"Y":pY+lastImgY});
            } else {
                var x_ = pX+lastImgX;
                var y_ = pY+lastImgY;
                if(pX+lastImgX>50) {
                    x_ = 50;
                }
                if(pX+lastImgX<cut+50-img.width*currentFactor) {
                    x_ = cut+50-img.width*currentFactor;
                }
                if(pY+lastImgY>50) {
                    y_ = 50;
                }
                if(pY+lastImgY<cut+50-img.height*currentFactor) {
                    y_ = cut+50-img.height*currentFactor;
                }
                return({"X":x_,"Y":y_});
            }
        }

        // initial factor calculation
        calculateFactor = function() {
            if(img.width<img.height) {
                minFactor = cut/img.width; // initial state
                currentFactor = cut/img.width;
                maxFactor = cut*2/img.width;
            } else {
                minFactor = cut/img.height;
                currentFactor = cut/img.height;
                maxFactor = cut*2/img.height;
            }
            // console.log(currentFactor,minFactor,maxFactor);
            initSlider();
        }

        // canvas position initialize
        canvasOriginPosition = function() {
            calculateFactor();
            var positionX;
            var positionY;
            if(img.width<img.height) {
                positionX = 50;
                positionY = 50 - (img.height*currentFactor - cut) /2;
            } else {
                positionX = 50 - (img.width*currentFactor - cut) /2;
                positionY = 50;
            }
            lastImgX = positionX;
            lastImgY = positionY;
            return({"positionX":positionX,"positionY":positionY});
        }

        window.onmousemove = function(e) {
            if(moving) {
                pX=e.clientX - lastmouseX;
                pY=e.clientY - lastmouseY;
                // console.log(checkPosition(pX,pY));
                redrawImg(pX,pY);
            }
        }

        // slide bar initialization
        initSlider = function() {
            mySlider.min = minFactor;
            mySlider.max = maxFactor;
            // mySlider.value = currentFactor;
            mySlider.step = 0.01;
        }

        mySlider.oninput = function() {
            currentFactor = mySlider.value;
            // redraw image position for every zoom operation
            // console.log("oninput",mySlider.value,lastImgX,lastImgY);
            redrawImg(0,0);
        }

        submitBtn.onclick = function() {
            // console.log("onclick!!",lastImgX,lastImgY);
            resultCxt.drawImage(img,lastImgX-50,lastImgY-50,img.width*currentFactor,img.height*currentFactor)
        }

        // pass the crop image to backend
        exportBtn.onclick = function() {
            var url = resultCanvas.toDataURL('image/jpg', 0.92);
            var arr = url.split(',');
            var mime = arr[0].match(/:(.*?);/)[1];
            var bstr = atob(arr[1]);
            var n = bstr.length;
            var u8arr = new Uint8Array(n);

            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }

            var obj = new Blob([u8arr], {type:mime});
            var fd = new FormData();
            fd.append("upfile", obj,"image.jpg");
            console.log(typeof(fd));

            $.ajax({
                url: "/cropimage",
                type: "POST",
                processData: false,
                contentType: false,
                data: fd,
                success: function (response) {
                    console.log(response);
                }
            })
        }
    </script>

    <script>
        var source = new EventSource("/progress");

        source.onmessage = function(event) {
              let div = document.querySelector('#flask_progress')
              let text = document.getElementById('flask_progress')

              div.style.width = event.data + '%'
              text.innerHTML = event.data + '%'

              if (event.data == 101) {
                  source.close()
              }
        }
    </script>

    <script>
        var chineseVertical = document.getElementById("chinese_vertical");
        var conditionalFlag = 0

        chineseVertical.addEventListener("change", function (event) {
            if (event.target.checked) {
                console.log("Checked");
                conditionalFlag = 1
            } else {
                console.log("Not checked");
                conditionalFlag = 0
            }

            $.post('/chinesevertical', {conditionalFlag}, function(){
                // do something once posted, if needed
            })
        });
    </script>

    <footer class="bg-secondary text-center text-white">
        <div class="text-center p-3">
            © Artificial Intelligence Driven OCR. MIAT LAB, NCU.
        </div>
    </footer>
</body>
</html>